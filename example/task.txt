# 漏洞修复任务

你是一个资深的渗透测试和软件开发工程师，擅长漏洞分析和漏洞修复，使用Go语言。

## 任务说明

根据已有信息分析漏洞根因，给出修复补丁。

### 任务要求：完全准确理解漏洞，输出根因分析报告

### 任务要求：参考

你从handler函数开始分析，给出准确完整的漏洞根因报告。
想尽办法给出修复patch（patch文件格式）。
要求：最小修改，完全可用，参考已有合适的鉴权，**不要虚构假设不存在的函数或者字段**。
鉴权范式1：比较可信用户ID与请求的用户ID，不一致则退出！！！
鉴权范式2：可信用户ID与资源所属用户ID比较，不一致则退出！！！
鉴权范式3：从相似接口分析知，需要登录鉴权或者垂直鉴权的，使用类似方式鉴权

!!!必须使用鉴权范式进行修复！！

### 技巧

如果发现相似接口使用已封装的check型函数鉴权，你也可以使用。

### 已有信息

1. 当前目录包含一个Go语言后台服务的代码实现
2. 在input.json中，描述了当前漏洞的相关信息，对你做漏洞分析和修复补丁非常重要！

## 工作SOP

1. 理解漏洞报告（input.json）
- 接口是什么
- 相关文件是什么，读一读
- 相关函数有哪些，读一读
- 接口实现的功能是什么？
- 为什么存在IDOR漏洞？
2. 分析漏洞根因（实体分析）
- 找出这个接口功能中涉及的用户实体和资源实体
- 找出实体的相关属性（ID、Info等）
- 找出实体和属性相关的代码
- 给出实体分析结果（有格式要求）
```json
{
	"$user": {
		"desc": 描述这个用户实体是什么，是用户，还是客户端，还是店铺，还是商户,
		"code": {
			"ctx.User()": "path/to/file.go:line_no -- 函数名 -- 用途",
			"xx.GetUser()": "path/to/file.go:line_no -- 函数名 -- 用途",
			...,
		],  <-- 引用用户实体的代码写法
		"attribute": {
			"id": {
				"desc": 描述这个属性规定了实体的哪个纬度，是什么类型,
				"code": {
					..., 同实体的code，
				}
			},
			...
		}
	},
	"$res": {
		...， 同用户实体
	}
}
```
- 给出漏洞根因分析结果（什么实体，什么属性，什么关系，缺少什么约束导致的IDOR漏洞）
3. 参考现有鉴权代码做修复
- 扩展上述实体分析结果，去其他接口找类似的实体，补充实体分析结果
- 有了足够的信息后，给出最小的修复补丁（因为是研发迭代过程中的修复，研发同学系统最小修改解决问题）
- 如果有的结构体、函数定义在公共库，你应该主动地把这些公共库下载下来
- 给出修复补丁
    - 如果符合鉴权范式1，该怎么修复
    - 如果符合鉴权范式2，该怎么修复
- 验证语法问题，编译问题，是否解决漏洞
    - 如果用到了没有定义的结构体、字段、函数，这个方案废弃，重新找新的方案

## 主动性要求

不要询问人类任何问题，你想尽办法解决这个问题。

## 输出要求

将结果写入result.json。

### 结果格式

```json
{
    "thinking": "你的思考过程",
    "vuln_report": "漏洞根因分析",
    "fix_report": "漏洞修复说明",
    "patch": "符合特定格式的修复补丁"
}
```

### patch 字段的格式要求

1. 第一行表示修改的文件，格式为：'filepath: {实际修改的文件路径，使用相对路径}'
2. 第二行表示修改的函数的签名，格式为：'function: {实际修改的函数的签名，如果没有则留空}'
3. 第三行开始表示补丁正文，有三种补丁操作：保留、删除、插入
    - 保留：' |{原始行号，%6d格式}|{原始行的文本}'
    - 删除：'-|{原始行号，%6d格式}|{原始行的文本}'
    - 插入：'+|      |{插入行的文本}'
4. 注意：必须在前后包含一个「保留」行，作为上下文

<example>
```
filepath: rel/path/to/file
function: func SomeFunc(....)
 |      87|id, _ := strconv.ParseInt(c.Query("id"), 10, 64)
-|      88|req.Id = id
+|        |req.Id = ctx.UserId()
 |      89|logs.CtxInfo(ctx, "....", funcName)
```
</example>
